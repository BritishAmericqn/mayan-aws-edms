Version 4.6
===========

Released: XXXX XX, XXXX

Changes
-------


Appearance
^^^^^^^^^^

- Reorganize templates:

  - Unify the blocks ``content`` and ``content_plain``.
  - Show the logo in the login form.
  - Move the logo font to the ``head`` template.
  - Split templates into small components.
  - Move templates into sub-folders and shorten their names.


Docker
^^^^^^

- Improve the index mirroring profile. Add ``MAYAN_MIRROR_INDEX_NAME`` to
  allow mounting different indexes without modifying the Docker Compose
  file.

- Debian image from 12.1-slim to 12.2-slim.
- Convert the Docker Compose file into a platform template.
- Convert the Docker Compose Keycloak services into a platform template.


Documents
^^^^^^^^^

- Commit the event "document version edited" when a document version pages
  are remapped.


Dependencies
^^^^^^^^^^^^

- Add ``ruff`` dependency, version 0.1.6.

- Update dependency versions:


  - JavaScript

    - jQuery from version 3.6.0 to 3.7.1.

  - Python

    - Update use of ``psycopg2`` version to 2.x to ``psycopg`` version 3.1.14.
    - AMQP from 5.1.0 to 5.2.0.
    - PIP from 23.2.1 to 23.3.1.
    - Add the Django series version to the setup generation script.
    - ``django-test-migrations`` from 1.1.0 to 1.3.0.
    - ``redis`` from 4.6.0 to 5.0.1.
    - ``wheel`` from 0.41.0 to 0.42.0.
    - ``bleach`` from 6.0.0 to 6.1.0.
    - ``django-auth-ldap`` from 4.4.0 to 4.6.0.
    - ``mozilla-django-oidc`` from 2.0.0 to 3.0.0.
    - ``pyotp`` from 2.6.0 to 2.9.0.
    - ``django-solo`` from 2.0.0 to 2.1.0.
    - ``django`` from 3.2 to 4.2.8.
    - ``django-mptt`` from 0.14.0 to 0.15.0.
    - ``sh`` from 2.0.4 to 2.0.6.
    - ``django-debug-toolbar`` from 3.2.4 to 4.2.0.
    - ``django-rosetta`` from 0.9.9 to 0.10.0.
    - ``django-silk`` from 5.0.3 to 5.0.3.
    - ``ipython`` from 8.14.0 to 8.18.1.
    - ``Pillow`` from 10.0.0 to 10.1.0.
    - ``pypdf`` from 3.14.0 to 3.17.1.
    - ``qrcode`` from 7.3.1 to 7.4.2.
    - ``node-semver`` from 0.8.1 to 0.9.0.
    - ``python_gnupg`` from 0.4.8 to 0.4.9.
    - ``graphviz`` from 0.17 to 0.20.1.
    - ``dateparser`` from 1.1.8 to 1.2.0.
    - ``pytz`` from 2022 to 2023.3.post1.
    - ``gevent`` from 22.10.2 to 23.9.1.
    - ``greenlet`` from 2.0.2 to 3.0.1.
    - ``sentry-sdk`` from 1.29.0 to 1.38.0.
    - ``whitenoise`` from 6.5.0 to 6.6.0.
    - ``django-cors-headers`` from 4.2.0 to 4.3.1.
    - ``jsonschema`` from 4.18.0 to 4.20.0.
    - ``CairoSVG`` from 2.5.2 to 2.7.1.
    - ``boto3`` from 1.28.16 to 1.33.7.
    - ``django-storages`` from 1.13.2 to 1.14.2.
    - ``extract-msg`` from 0.37.1 to 0.46.2.
    - ``pycryptodome`` from 3.18.0 to 3.19.0.
    - ``celery`` from 5.3.5 to 5.3.6.
    - ``coverage`` from 5.5 to 6.5.0.
    - ``coveralls`` from 3.2.0 to 3.3.1.
    - ``psutil`` from 5.8.0 to 5.9.6.
    - ``django-widget-tweaks`` from 1.4.12 to 1.5.0.


File metadata
^^^^^^^^^^^^^

- Refactor file metadata app:

  - Allow multiple drivers to execute for the same MIME types.
  - Automatically find and import file metadata drivers.
  - Add a normalized internal name field for file metadata drive attributes.
    This solves the issue where attributes with spaces were not usable
    in templates. Spaces are converted into underscores. Uppercase letters
    in attributes are converted to lowercase.
  - Existing file metadata template references need to be updated for
    attribute letter casing.
  - Add view to display all detected file metadata drivers.
  - Process all file metadata drivers as parallel background tasks.

- Add antivirus scanning for documents. Implemented as a file metadata
driver and a new app named ``file_metadata_clamav``. ClamAV and the latest
database are included in the Docker image.
- Move file metadata queue to worker D.


Lock manager
^^^^^^^^^^^^

- Generate unique test lock names to avoid unintended lock errors when
  validating the lock manager backend. Closes GitLab issue #1157, thanks
  to Mathias Behrle (@mbehrle) for the report.


Mailer
^^^^^^

- Mailer app refactor

  - Replace uses of ``mailer`` and ``user mailer`` to ``mailing profile``.
  - Add mailing profile API.
  - Add generic object mailing API. Supports emailing object links and
    object attachments.
  - Add class ``ModelMailingAction`` to defined available mailing actions
    per model.
  - Use the ``__title__`` and ``__website__`` from the ``mayan`` module
    as the email's body project name and website.




Settings
^^^^^^^^

- Refactor the smart settings app. Setting value changes no longer take
  effect immediately or trigger saving the configuration file. Added a new
  view to save the current settings into a new configuration file. Setting
  post edit functions are now execute during startup and not after editing
  the setting. Added a new view and link to revert unsaved settings.
- Expose Django's setting named ``CSRF_TRUSTED_ORIGINS`` via the smart
  settings app.
- Expose Django's setting named ``CSRF_COOKIE_SECURE`` via the smart
  settings app.
- Expose Django's setting named ``CSRF_USE_SESSIONS`` via the smart
  settings app.


Task manager
^^^^^^^^^^^^

- Convert worker nice levels from literals to config constants.


Other
^^^^^

- Override the test runner's logging setup to avoid having its output
  being concatenated when calling management commands and makefile targets.
- Support source column resolution for non model subclasses.
- Normalize the permission system to work with single permissions per filter
  or check.
- Update minimum and recommended requirements.
- Lower the severity of searching indexing problems to ``INFO``. This
  reduces user confusion between normal messages when processing the
  asynchronous task queue and actual coding errors.
- Optimize document type retention policy queries.
- Minor optimization to the ACL calculation queries.
- Fix search query warning when parsing dates. Default all date values the
  timezone UTC.
- Optimize the file cache eviction selection.
- Check if database tables are available before preloading and caching
  permissions and file metadata drivers.
- Use the correct ``post_load_modules`` method to execute initialization
  code after app module loading.
- Reorganize make files. Remove unused and outdated targets. Move all Docker
  related targets to the Docker make file. Improve staging targets.


Removals
--------

.. include:: partials/removals-4.6.txt


Backward incompatible changes
-----------------------------

.. include:: partials/backward-incompatible-4.6.txt


Deprecations
------------

.. include:: partials/deprecations-4.6.txt


Issues closed
-------------

- None

.. _PyPI: https://pypi.python.org/pypi/mayan-edms/
